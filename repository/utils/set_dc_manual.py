from artiq.experiment import *
from artiq.language.core import  kernel, TerminationRequested

from acf.experiment import _ACFExperiment
from acf_sequences.sequences import sequences
from acf_config.arguments_definition import argument_manager

class SetDCManual(EnvExperiment):       

    def build(self):
        self.setattr_device("core")
        self.setattr_device("zotino0")

        # 32 channels, 0.1 V for first channel, 0.2 V for second channel, ..., 0.32 V for 32nd channel
        self.channels = [i for i in range(32)]

        # self.list_of_voltages = [{'DC21': 1.1, 'DC20': 1.0, 'DC19': 1.0, 'DC18': -1.0, 'DC17': 1.0, 'DC16': -1.0, 'DC15': -1.0, 'DC14': -1.0, 'DC13': -1.0, 'DC12': -1.0, 'DC11': -1.0, 'DC10': -1.0, 'DC9': -1.0, 'DC8': -1.0, 'DC7': -1.0, 'DC6': -1.0, 'DC5': -1.0, 'DC4': -1.0, 'DC3': -1.0, 'DC2': -1.0, 'DC1': -1.0}]

        # self.list_of_voltages = [{'DC12': -0.6206902556739394, 'DC21': -1.1022211249592764, 'DC20': -1.1348286755026922, 'DC19': 2.784226752812928, 'DC18': -5.502326653709042, 'DC17': 1.194017497002936, 'DC16': 1.1659314109113068, 'DC15': 0.2719000687005087, 'DC14': -0.09026643293922579, 'DC13': -0.21259465805606834, 'DC9': -1.1743543329867876, 'DC6': -1.4954784582995182, 'DC10': -1.9317569211185273, 'DC8': 0.0, 'DC7': 0.0, 'DC11': -3.1738809768978875, 'DC4': -1.0832987764314947, 'DC1': -0.6813522383679972, 'DC3': -0.4995585781707656, 'DC2': -0.4018516645097744, 'DC5': -1.0788882998684302}]

        # self.list_of_voltages = [{'DC21': -9.99, 'DC20': -9.0, 'DC19': -8.0, 'DC18': -7.0, 'DC17': -6.0, 'DC16': -5.0, 'DC15': -4.0, 'DC14': -3.0, 'DC13': -2.0, 'DC12': -1.0, 'DC10': +1.0, 'DC9': +2.0, 'DC8': +3.0, 'DC7': +4.0, 'DC6': +5.0, 'DC5': +6.0, 'DC4': +7.0, 'DC3': +8.0, 'DC2': +9.0, 'DC1': +9.99, 'DC11': +0.75}]

        self.list_of_voltages = [
            # {'DC21': 0.04367947637940177, 'DC20': 0.02449257058984275, 'DC19': 0.41519301995974, 'DC18': 0.23258385049031943, 'DC17': 1.1593774592869284, 'DC16': 2.726311488492673, 'DC15': -2.753747788771533, 'DC14': -1.530325025380511, 'DC13': 3.2496089400954435, 'DC12': 1.8670492845185227, 'DC10': 0.0448380206890515, 'DC9': 0.050920423034254494, 'DC8': 0.05795636916409533, 'DC7': 0.10200393206545866, 'DC6': 0.4056439521057499, 'DC5': 0.5682943231624529, 'DC4': -1.9201678463152883, 'DC3': -1.4769761673642692, 'DC2': 1.3552932044700015, 'DC11': -0.3160990344107006, 'DC1': 0.0},
        
        
        # {'DC21': 0.2397259657802227, 'DC20': 0.3355969353013055, 'DC19': 0.43101414725880616, 'DC18': 0.863591906909872, 'DC17': 1.9910736517920067, 'DC16': 2.634953938331349, 'DC15': -0.2268934038958248, 'DC14': -2.287162074534368, 'DC13': 3.6393767332393816, 'DC12': 2.7367867301386677, 'DC10': 0.34549951631217385, 'DC9': 0.44661080455477575, 'DC8': 0.5491013060358161, 'DC7': 0.991218093174095, 'DC6': 2.010582626586247, 'DC5': 2.1586093983070898, 'DC4': -0.5458311108239576, 'DC3': -1.661743859982539, 'DC2': 2.9182220907073493, 'DC11': -0.08444825767939342, 'DC1': 0.0},

        # {'DC21': 0.1862237516680953, 'DC20': 0.2640259579633904, 'DC19': 0.35121568179831913, 'DC18': 0.7418391282211958, 'DC17': 1.9488312858927364, 'DC16': 2.800450799847173, 'DC15': -1.0940588329217928, 'DC14': -2.2268520681621102, 'DC13': 3.6769255806710746, 'DC12': 2.4583926902429094, 'DC10': 0.2516839241477532, 'DC9': 0.3267295784532752, 'DC8': 0.40016547530859675, 'DC7': 0.7183970840128789, 'DC6': 1.5683372843584404, 'DC5': 1.601251261677778, 'DC4': -1.0947693963654193, 'DC3': -1.5529735770156035, 'DC2': 2.306008988869351, 'DC11': -0.1673088121072373, 'DC1': 0.0},

        # {'DC21': 0.16380442338818213, 'DC20': 0.23229957799015682, 'DC19': 0.31528917295678777, 'DC18': 0.6812552569556254, 'DC17': 1.8775495237367639, 'DC16': 2.780043373009517, 'DC15': -1.2332624861738681, 'DC14': -2.3175956621811453, 'DC13': 3.57452047154258, 'DC12': 2.3075623444864295, 'DC10': 0.21464415925119604, 'DC9': 0.2798189127928844, 'DC8': 0.3423083219125262, 'DC7': 0.6228034248100319, 'DC6': 1.3949271383467985, 'DC5': 1.4031151701952962, 'DC4': -1.1940214341387485, 'DC3': -1.6155075409547135, 'DC2': 2.014845532209149, 'DC11': -0.20016890578311486, 'DC1': 0.0}

        # {'DC21': 0.14138509510826902, 'DC20': 0.20057319801692333, 'DC19': 0.2793626641152564, 'DC18': 0.620671385690055, 'DC17': 1.8062677615807918, 'DC16': 2.7596359461718607, 'DC15': -1.372466139425943, 'DC14': -2.408339256200181, 'DC13': 3.472115362414085, 'DC12': 2.1567319987299505, 'DC10': 0.1776043943546389, 'DC9': 0.23290824713249356, 'DC8': 0.2844511685164557, 'DC7': 0.5272097656071851, 'DC6': 1.221516992335157, 'DC5': 1.2049790787128147, 'DC4': -1.2932734719120773, 'DC3': -1.6780415048938235, 'DC2': 1.7236820755489466, 'DC11': -0.23302899945899236, 'DC1': 0.0},

        # {'DC21': 0.23106240822792154, 'DC20': 0.32747871790985755, 'DC19': 0.42306869948138176, 'DC18': 0.8630068707523366, 'DC17': 2.0913948102046813, 'DC16': 2.841265653522486, 'DC15': -0.8156515264176433, 'DC14': -2.0453648801240396, 'DC13': 3.881735798928065, 'DC12': 2.7600533817558683, 'DC10': 0.3257634539408675, 'DC9': 0.42055090977405696, 'DC8': 0.5158797821007379, 'DC7': 0.909584402418573, 'DC6': 1.9151575763817235, 'DC5': 1.997523444642741, 'DC4': -0.8962653208187612, 'DC3': -1.4279056491373834, 'DC2': 2.8883359021897563, 'DC11': -0.10158862475548221, 'DC1': 0.0}

        # {'DC21': 0.14138509510826902, 'DC20': 0.20057319801692333, 'DC19': 0.2793626641152564, 'DC18': 0.620671385690055, 'DC17': 1.8062677615807918, 'DC16': 2.7596359461718607, 'DC15': -1.372466139425943, 'DC14': -2.408339256200181, 'DC13': 3.472115362414085, 'DC12': 2.1567319987299505, 'DC10': 0.1776043943546389, 'DC9': 0.23290824713249356, 'DC8': 0.2844511685164557, 'DC7': 0.5272097656071851, 'DC6': 1.221516992335157, 'DC5': 1.2049790787128147, 'DC4': -1.2932734719120773, 'DC3': -1.6780415048938235, 'DC2': 1.7236820755489466, 'DC11': -0.23302899945899236, 'DC1': 0.0}

        # {'DC21': 0.23106240822792154, 'DC20': 0.32747871790985755, 'DC19': 0.42306869948138176, 'DC18': 0.8630068707523366, 'DC17': 2.0913948102046813, 'DC16': 2.841265653522486, 'DC15': -0.8156515264176433, 'DC14': -2.0453648801240396, 'DC13': 3.881735798928065, 'DC12': 2.7600533817558683, 'DC10': 0.3257634539408675, 'DC9': 0.42055090977405696, 'DC8': 0.5158797821007379, 'DC7': 0.909584402418573, 'DC6': 1.9151575763817235, 'DC5': 1.997523444642741, 'DC4': -0.8962653208187612, 'DC3': -1.4279056491373834, 'DC2': 2.8883359021897563, 'DC11': -0.10158862475548221, 'DC1': 0.0}

        # {'DC21': 0.2419743100018359, 'DC20': 0.20225960774834967, 'DC19': 0.42878225239354034, 'DC18': 0.8634505665471385, 'DC17': 2.0940456671175096, 'DC16': 2.852821168824171, 'DC15': -0.8650785618928833, 'DC14': -2.0221045002201357, 'DC13': 3.8990327975316283, 'DC12': 2.76115104915777, 'DC10': 0.3249765526166857, 'DC9': 0.42215985526637323, 'DC8': 0.5158039223467678, 'DC7': 0.9066295739913542, 'DC6': 1.9179644018685642, 'DC5': 1.9898443780513406, 'DC4': -0.931017222742142, 'DC3': -1.4100262793793275, 'DC2': 2.8907093904278227, 'DC11': -0.10336035472382073, 'DC1': 0.0}

        # {'DC21': 0.23427081761917012, 'DC20': 0.27086878374946644, 'DC19': 0.42262199991039984, 'DC18': 0.8568422714110395, 'DC17': 2.083641463562268, 'DC16': 2.851721795541179, 'DC15': -0.9003047506025651, 'DC14': -2.001419857416406, 'DC13': 3.919478947731794, 'DC12': 2.7669542910367624, 'DC10': 0.3233632717459413, 'DC9': 0.41813060302508726, 'DC8': 0.5119338845632189, 'DC7': 0.9003960650600984, 'DC6': 1.907034759170398, 'DC5': 1.9779311867922416, 'DC4': -0.9497985576485322, 'DC3': -1.3967865937460913, 'DC2': 2.899371830997872, 'DC11': -0.10419760580852874, 'DC1': 0.0}

        # {'DC21': 0.22593885734959607, 'DC20': 0.31936154860747373, 'DC19': 0.41315200031069144, 'DC18': 0.869361899167319, 'DC17': 2.057274122625708, 'DC16': 2.8582528069822057, 'DC15': -0.9601917088657035, 'DC14': -1.9502428886449792, 'DC13': 3.966206139744961, 'DC12': 2.780564687429095, 'DC10': 0.31831398947516903, 'DC9': 0.41009934307438267, 'DC8': 0.5011504375066624, 'DC7': 0.9456154480042744, 'DC6': 1.8888139290262809, 'DC5': 1.9389399269173841, 'DC4': -0.9801072292502445, 'DC3': -1.334179752735253, 'DC2': 2.891524264084193, 'DC11': -0.10250273413597658, 'DC1': 0.0}

        # {'DC21': 0.22356624545265755, 'DC20': 0.31607939029684406, 'DC19': 0.4090705663863054, 'DC18': 0.8644372634648047, 'DC17': 2.069469660046537, 'DC16': 2.8937353736651135, 'DC15': -1.0776258248251396, 'DC14': -1.9231223608358723, 'DC13': 4.015098112294109, 'DC12': 2.799617808239937, 'DC10': 0.3148595427880988, 'DC9': 0.4057189127203414, 'DC8': 0.497367558801425, 'DC7': 0.8558549528032219, 'DC6': 1.855735464501592, 'DC5': 1.9459370094289032, 'DC4': -1.0664928192292042, 'DC3': -1.314551528758534, 'DC2': 2.8860226561438562, 'DC11': -0.109495520746822, 'DC1': 0.0}

        # {'DC21': 0.22191409748158245, 'DC20': 0.31356374294023276, 'DC19': 0.4057542528367309, 'DC18': 0.8611755446119009, 'DC17': 2.0656543556599294, 'DC16': 2.9068002567826734, 'DC15': -1.165555035827274, 'DC14': -1.8642929343170156, 'DC13': 4.058303509210098, 'DC12': 2.793757243578812, 'DC10': 0.31294337768059377, 'DC9': 0.40276115008935703, 'DC8': 0.493327887890485, 'DC7': 0.8447721507695132, 'DC6': 1.8376145695179775, 'DC5': 1.9457245739417743, 'DC4': -1.1162359869985758, 'DC3': -1.2799155746281499, 'DC2': 2.8962822609859082, 'DC11': -0.11030115832335835, 'DC1': 0.0}

        {'DC21': 0.31749325387952326, 'DC20': 0.44490114797646824, 'DC19': 0.5719687472206784, 'DC18': 1.170130052952694, 'DC17': 2.5807715194130303, 'DC16': 3.4144558219422896, 'DC15': -0.778548889751316, 'DC14': -1.67502241479424, 'DC13': 4.893704821650458, 'DC12': 3.5795161855258786, 'DC10': 0.45082601863578564, 'DC9': 0.5769718662392411, 'DC8': 0.7033210026438269, 'DC7': 1.1877931979225766, 'DC6': 2.3972668435538984, 'DC5': 2.5610520194221253, 'DC4': -0.2772239496394273, 'DC3': -0.49078228170827, 'DC2': 3.767104859766341, 'DC11': 0.051503406739957173, 'DC1': 0.0}

        ]
        
        self.voltage_sets = []
        # Pre-process all voltage sets
        for i, voltage_set in enumerate(self.list_of_voltages):
            # Create a copy to work with
            remapped_voltages = voltage_set.copy()
            
            # Adjust values
            for key, value in remapped_voltages.items():
                if value > 10.0:
                    remapped_voltages[key] = 9.9
                elif value < -10.0:
                    remapped_voltages[key] = -9.9
            
            # Create the voltage array for this set
            voltages = [round(remapped_voltages[f"DC{i}"], 8) for i in range(1, 22)]
            voltages.extend([1.0, 1.1, 0.0])
            # For others, set to 0
            voltages.extend([0.0] * (32 - len(voltages)))
            
            # Add to our list of prepared voltage sets
            self.voltage_sets.append(voltages)
            
            # Print the processed voltage set
            print("Prepared voltage set {}: {}".format(i, voltages))
        
        print("Total prepared voltage sets: {}".format(len(self.voltage_sets)))
        self.index = 0

    @kernel
    def run(self):
        self.core.reset()
        self.core.break_realtime()
        self.zotino0.init()
        delay(10*ms)
        
        # Loop continually through all voltage sets
        while True:
            try:
                for i in range(len(self.voltage_sets)):
                    # Apply this set of voltages
                    voltages = self.voltage_sets[i]
                    self.zotino0.set_dac(voltages, self.channels)
                    print("Applied voltage set")
                    
                    # Wait for 10 seconds before next set
                    delay(30*s)
            except TerminationRequested:
                print("Termination requested")
                break
